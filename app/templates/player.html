<!-- extned from base layout -->
{% extends "layout.html" %}

{% block body %}
  <title>Audiobook Player</title>
    <h1>Play on player</h1>

    {% if booktitle %}
    <h3>{{ booktitle }}</h3>
    {% else %}
    <h3 id='currentPlaying'>No Title Present</h3>
    {% endif %}
    <div id='player'>
      <audio width:"100%"; onclick="play(this)" id='audio' controls="true">
        <!-- <source src="static/audio/foo/foo.mp3" > -->
        <source src="" >
        Your browser does not support the audio element.
      </audio>
    </div>

    <img id='loading' style='display: none' src='/static/img/loading.gif'>

    <div>
      <ul style="list-style-type:none">
      {% if booklist|length > 0 %}
        {% for book in booklist %}
            <li id={{ book.id }}><a href="javascript:void(0);">{{ book.title }}</a></li>
        {% endfor %}
      {% else %}
         You have no Books in the checked out<br/>
         Head over to the <a href="{{ url_for('library')}}">Library<a>
      {% endif %}
      </ul>
    </div>
    <button id=buttoni class="w3-btn w3-blue" type="submit" onclick="wowo(buttoni)">buttoni</button>


    <script type='text/javascript'>
     $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
    current_playing_id = null

    var get_li = function() {
      //get the LI tags
      var tags_li = document.getElementsByTagName('li');
      var nr_li = tags_li.length;
      // traverse the "tags_li" array
      for (i=0; i<nr_li; i++) {
        // apply the 'onclick' event to each, assigning a function that must be called by this event
        tags_li[i].onclick = function() {
          // var continut = '/'+this.id+'/'+this.textContent || this.innerText +'.mp3'; // gets the content
          var continut = '/'+this.id+'/'+this.textContent+'.mp3'; // gets the content
          console.log(continut)
          current_playing_id = this.id
          document.getElementById('audio').setAttribute('src', '/audio'+continut);
          document.getElementById('currentPlaying').innerHTML = this.textContent;
          //var t = timeInfo('currentTime=none&book_id='+current_playing_id);
          timeInfo(current_playing_id);
          console.log('ran after timeInfo function')
        };
      }
    };


    console.log('start!')
    var aud = document.getElementById('audio')
    console.log('aud.paused state: '+aud.paused)
    //console.log('aud = '+aud)
    aud.addEventListener('pause', printTime)
    // jQuery $('#aud').on('pause', getTime)
    function printTime (){
      console.log('current time = '+aud.currentTime)
    }


    document.body.onkeypress = function(e){
      if(e.keyCode == 32){
        console.log('space bar pressed')
        if (aud.paused) {
          console.log('status is paused')
          console.log('playing')
          aud.play()
        } else {
          console.log('pausing')
          aud.pause()
        }
      }
    }


    // jQuery version of javascript below (mostly)
    // {% for book in booklist %}
    //    $('li').click(function(){
    //      var str = $(this).text()
    //      //console.log(str)
    //      $('audio').attr('src', '/audio/'+str);
    //      $('currentPlaying').innerHTML = this.textContent;
    //    });
    // {% endfor %}


    // jQuery for timed events
    // $(document).ready(function(){
    //   console.log('ready!');
    //   //i=0;
    //   setInterval(hey, 1000);
    // });

    // function hey(){
    //       //i++
    //       console.log('Hey! seconds has gone by.')
    //       console.log('curretTime = '+aud.currentTime)
    // }

    // m = aud.currentTime;
    // n = "/postTime/?time="+aud.currentTime+'&'+'current_playing_id='+current_playing_id
    // nn = "/postTime/time="+aud.currentTime+'&'+'current_playing_id='+current_playing_id
    // what = typeof m;
    // console.log(what)
    // $('Button').click(
    //   function testPost() {
    //     console.log('current playing id = '+current_playing_id)
    //     var req = new XMLHttpRequest();
    //     req.open("POST",nn)
    //     //req.send(n)
    //     req.send()
    //     //console.log('time = '+m)
    //     console.log('aud.currentTime = '+aud.currentTime)
    //     console.log(req.status, req.statusText);
    //     console.log('req.getResponseHeader(content-type) = '+req.getResponseHeader('content-type'))
    // });



    var url = "/time";

    document.getElementById('audio').onpause = function() {
    //if(http.readyState == 4 && http.status == 200) {
        // alert(http.responseText);
        var http = new XMLHttpRequest();
        var params = "currentTime="+aud.currentTime+'&book_id='+current_playing_id;
        console.log('*************** in onpause function ***********');
        console.log('params in send = '+params);
        http.open("POST",url,true);
        //http.setRequestHeader("Content-type","application/json;charset=UTF-8")
        //http.send(JSON.stringify({id:current_playing_id,currentTime:aud.currentTime}));
        //Send the proper header information along with the request
        http.setRequestHeader('Content-type','application/x-www-form-urlencoded')
        http.send(params);
        // http.send({'id':'somenumber','time':'sometime'})
        }

    // function timeInfo(params) {
    //     var http = new XMLHttpRequest();
    //     // var params ='book_id='+current_playing_id;
    //     http.open('POST',url,true);
    //     http.setRequestHeader('Content-type','application/x-www-form-urlencoded')
    //     http.send(params)
    //     console.log('http.responseText = '+http.responseText)
    //     console.log('params = '+params);
    //   }

    // function timeInfo(book_id) {
    //   $(player).hide();
    //   $(loading).show();
    //   $.ajax('/time', {
    //      book_id: book_id
    //    }).done(function(book) {
    //          //waitForIt(cuser)
    //          //aud.currentTime = book.currentTime;
    //          console.log('book.id = '+book.id)
    //          $(loading).hide();
    //          $(player).show();
    //          console.log('done ran')
    //          //console.log('got yo '+cuser.user)
    //          //return cuser.user
    //      }).fail(function() {
    //          console.log('fail')
    //      });
    //   }



    function waitForIt(bookID){
      console.log('got it! '+bookID.user)
    }

    function wowo(targetid) {
      $(targetid).hide();
    }

    function timeInfo(book_id) {
      $.ajax({
        type: 'POST',
        url: '/time',
        data: JSON.stringify({'book_id':current_playing_id}, null, '\t'),
        contentType: 'application/json;charset=UTF-8',
        success: function(currentBookTime) {
            console.log('currentBookTime = '+currentBookTime.currentBookTime)
            aud.currentTime = currentBookTime.currentBookTime;
            $(loading).hide();
            $(player).show();
            console.log('done ran');
        // fail: function() {
        //     consol.log('fail')
        //   }
      }
    });
  }


    window.onload = get_li;
    </script>

{% endblock %}
